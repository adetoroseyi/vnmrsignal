<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNMR Classic - Backtesting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
        }
        #assessmentCard {
            transition: all 0.3s ease;
        }
        #assessmentRecommendation {
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-4xl font-bold text-slate-900 mb-2">
                            üéØ VNMR Classic Backtesting
                        </h1>
                        <p class="text-slate-600">
                            Test the VNMR Classic strategy on 5 years of historical data
                        </p>
                    </div>
                    <a href="vnmr-classic.html" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-semibold">
                        ‚Üê Back to Live
                    </a>
                </div>
            </div>

            <!-- Configuration Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Backtest Configuration</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Pair Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Currency Pair
                        </label>
                        <select id="pairSelect" class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                            <option value="EUR_USD">EUR/USD</option>
                            <option value="GBP_USD">GBP/USD</option>
                            <option value="EUR_GBP">EUR/GBP</option>
                            <option value="AUD_NZD">AUD/NZD</option>
                            <option value="EUR_CHF">EUR/CHF</option>
                            <option value="USD_JPY">USD/JPY</option>
                            <option value="USD_CAD">USD/CAD</option>
                            <option value="AUD_USD">AUD/USD</option>
                            <option value="XAU_USD">XAU/USD (Gold)</option>
                            <option value="NZD_USD">NZD/USD</option>
                            <option value="USD_CHF">USD/CHF</option>
                            <option value="EUR_AUD">EUR/AUD</option>
                            <option value="GBP_AUD">GBP/AUD</option>
                            <option value="AUD_CAD">AUD/CAD</option>
                        </select>
                    </div>

                    <!-- Timeframe Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Timeframe
                        </label>
                        <select id="timeframeSelect" class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                            <option value="M30">30 Minutes (M30)</option>
                            <option value="H1" selected>1 Hour (H1)</option>
                            <option value="H4">4 Hours (H4)</option>
                        </select>
                    </div>

                    <!-- Historical Period Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Historical Period
                        </label>
                        <select id="yearsSelect" class="w-full p-3 border-2 border-green-500 rounded-lg text-lg font-semibold">
                            <option value="1">1 Year (Fast)</option>
                            <option value="2" selected>2 Years (Recommended)</option>
                            <option value="3">3 Years</option>
                            <option value="5">5 Years (Slow)</option>
                        </select>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-col justify-end gap-2">
                        <button onclick="openAdvancedSettings()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-3 rounded-lg font-semibold">
                            ‚öôÔ∏è Advanced Settings
                        </button>
                        <button onclick="runBacktest()" id="runBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold text-lg">
                            üöÄ Run Backtest
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" style="display:none;" class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span id="progressText" class="text-sm font-semibold text-slate-700">Fetching data...</span>
                        <span id="progressPercent" class="text-sm font-semibold text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3">
                        <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" style="display:none;">
                <!-- Performance Assessment -->
                <div id="assessmentCard" class="rounded-lg shadow-lg p-6 mb-6" style="display:none;">
                    <div class="flex items-start gap-4">
                        <div id="assessmentIcon" class="text-6xl">‚≠ê</div>
                        <div class="flex-1">
                            <h2 class="text-3xl font-bold mb-2" id="assessmentTitle">Excellent Strategy</h2>
                            <p class="text-lg mb-4" id="assessmentSubtitle">This strategy shows strong performance across all metrics</p>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                <div class="flex items-center gap-2">
                                    <span id="ratingROI" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>ROI:</strong> <span id="ratingROIText">Good</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="ratingWinRate" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>Win Rate:</strong> <span id="ratingWinRateText">Good</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="ratingPF" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>Profit Factor:</strong> <span id="ratingPFText">Good</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="ratingDD" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>Drawdown:</strong> <span id="ratingDDText">Good</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="ratingTrades" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>Trade Count:</strong> <span id="ratingTradesText">Good</span></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="ratingRR" class="text-2xl">‚úÖ</span>
                                    <span class="text-sm"><strong>Avg R:R:</strong> <span id="ratingRRText">Good</span></span>
                                </div>
                            </div>
                            
                            <div id="assessmentRecommendation" class="bg-white bg-opacity-50 p-4 rounded-lg">
                                <div class="font-semibold mb-2">üí° Recommendation:</div>
                                <p id="assessmentRecommendationText" class="text-sm">
                                    This strategy is ready for paper trading. Monitor performance over 1-2 months before going live.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">Performance Summary</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="metric-card bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border-2 border-green-200">
                            <div class="text-sm text-green-700 mb-1">Total ROI</div>
                            <div id="metricROI" class="text-3xl font-bold text-green-600">--</div>
                        </div>
                        <div class="metric-card bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-2 border-blue-200">
                            <div class="text-sm text-blue-700 mb-1">Win Rate</div>
                            <div id="metricWinRate" class="text-3xl font-bold text-blue-600">--</div>
                        </div>
                        <div class="metric-card bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-2 border-purple-200">
                            <div class="text-sm text-purple-700 mb-1">Profit Factor</div>
                            <div id="metricProfitFactor" class="text-3xl font-bold text-purple-600">--</div>
                        </div>
                        <div class="metric-card bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border-2 border-red-200">
                            <div class="text-sm text-red-700 mb-1">Max Drawdown</div>
                            <div id="metricDrawdown" class="text-3xl font-bold text-red-600">--</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-xs text-slate-600 mb-1">Total Trades</div>
                            <div id="metricTotalTrades" class="text-2xl font-bold text-slate-900">--</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-xs text-slate-600 mb-1">Winning Trades</div>
                            <div id="metricWinningTrades" class="text-2xl font-bold text-green-600">--</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-xs text-slate-600 mb-1">Losing Trades</div>
                            <div id="metricLosingTrades" class="text-2xl font-bold text-red-600">--</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-xs text-slate-600 mb-1">Avg Win</div>
                            <div id="metricAvgWin" class="text-2xl font-bold text-green-600">--</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-xs text-slate-600 mb-1">Avg Loss</div>
                            <div id="metricAvgLoss" class="text-2xl font-bold text-red-600">--</div>
                        </div>
                    </div>
                </div>

                <!-- Equity Curve -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">Equity Curve</h2>
                    <div class="relative" style="height: 400px;">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>

                <!-- Trade Log -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">Trade Log</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full" id="tradeLogTable">
                            <thead>
                                <tr class="bg-slate-100 border-b-2 border-slate-300">
                                    <th class="p-3 text-left text-sm font-semibold">Trade #</th>
                                    <th class="p-3 text-left text-sm font-semibold">Entry Date</th>
                                    <th class="p-3 text-left text-sm font-semibold">Direction</th>
                                    <th class="p-3 text-left text-sm font-semibold">Entry</th>
                                    <th class="p-3 text-left text-sm font-semibold">Exit</th>
                                    <th class="p-3 text-left text-sm font-semibold">Exit Date</th>
                                    <th class="p-3 text-left text-sm font-semibold">P&L</th>
                                    <th class="p-3 text-left text-sm font-semibold">R:R</th>
                                </tr>
                            </thead>
                            <tbody id="tradeLogBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Initial Message -->
            <div id="initialMessage" class="bg-white rounded-lg shadow-lg p-12 text-center">
                <div class="text-6xl mb-4">üìä</div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Ready to Backtest</h2>
                <p class="text-slate-600 mb-4">
                    Select a currency pair, timeframe, and historical period, then click "Run Backtest"
                </p>
                <p class="text-sm text-slate-500 mb-2">
                    <strong>‚ö° Speed Tips:</strong>
                </p>
                <ul class="text-sm text-slate-500 text-left max-w-md mx-auto">
                    <li>‚Ä¢ <strong>1 Year:</strong> Fast (15-30 sec) - Good for quick testing</li>
                    <li>‚Ä¢ <strong>2 Years:</strong> Recommended (30-60 sec) - Best balance</li>
                    <li>‚Ä¢ <strong>5 Years:</strong> Slow (2-3 min) - Most comprehensive</li>
                    <li>‚Ä¢ <strong>H4 timeframe:</strong> Fastest to load</li>
                    <li>‚Ä¢ <strong>M30 timeframe:</strong> Slowest (more data points)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Advanced Settings Modal -->
    <div id="advancedModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Advanced Settings</h2>
                    <button onclick="closeAdvancedSettings()" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                </div>
                
                <div class="space-y-6">
                    <!-- EMA Period -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            EMA Period
                        </label>
                        <input type="number" id="settingsEMAPeriod" value="50" min="10" max="200" 
                            class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 50</p>
                    </div>

                    <!-- ATR Period -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            ATR Period
                        </label>
                        <input type="number" id="settingsATRPeriod" value="20" min="10" max="50" 
                            class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 20</p>
                    </div>

                    <!-- Deviation Threshold -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Deviation Threshold (Standard Pairs)
                        </label>
                        <input type="number" id="settingsDeviation" value="1.5" step="0.1" min="0.5" max="5.0" 
                            class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 1.5 | Distance from EMA in ATRs</p>
                    </div>

                    <!-- Deviation Threshold Gold -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Deviation Threshold (Gold XAU/USD)
                        </label>
                        <input type="number" id="settingsDeviationGold" value="2.0" step="0.1" min="0.5" max="5.0" 
                            class="w-full p-3 border-2 border-yellow-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 2.0 | Higher threshold for Gold's volatility</p>
                    </div>

                    <!-- ATR Slope Max -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            ATR Slope Maximum
                        </label>
                        <input type="number" id="settingsATRSlope" value="0" step="0.00001" min="-0.001" max="0.001" 
                            class="w-full p-3 border-2 border-blue-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 0 | Must be ‚â§ this value</p>
                    </div>

                    <!-- Stop Loss Multiplier -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">
                            Stop Loss Multiplier (ATR)
                        </label>
                        <input type="number" id="settingsSLMultiplier" value="2.5" step="0.1" min="1.0" max="5.0" 
                            class="w-full p-3 border-2 border-red-500 rounded-lg text-lg font-semibold">
                        <p class="text-xs text-slate-500 mt-1">Default: 2.5 | SL = Entry ¬± (ATR √ó Multiplier)</p>
                    </div>

                    <!-- R:R Filter -->
                    <div>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="settingsRRFilter" checked class="w-5 h-5">
                            <div>
                                <div class="text-sm font-semibold text-slate-700">Enable R:R Filter (Min 1.0)</div>
                                <div class="text-xs text-slate-500">Block signals where Risk:Reward ratio < 1.0</div>
                            </div>
                        </label>
                    </div>

                    <!-- Session Filter -->
                    <div>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="settingsSessionFilter" checked class="w-5 h-5">
                            <div>
                                <div class="text-sm font-semibold text-slate-700">Enable Session Filter</div>
                                <div class="text-xs text-slate-500">Only trade during optimal windows (00:30-07:30, 09:00-12:30, 15:00-17:30)</div>
                            </div>
                        </label>
                    </div>

                    <!-- RSI Settings -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">RSI Settings</h3>
                        
                        <div class="mb-4">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" id="settingsRSIFilter" class="w-5 h-5">
                                <div>
                                    <div class="text-sm font-semibold text-slate-700">Enable RSI Filter</div>
                                    <div class="text-xs text-slate-500">Require RSI confirmation for signals</div>
                                </div>
                            </label>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-700 mb-1">RSI Period</label>
                                <input type="number" id="settingsRSIPeriod" value="14" min="7" max="21" 
                                    class="w-full p-2 border border-blue-400 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Oversold</label>
                                <input type="number" id="settingsRSIOversold" value="30" min="20" max="40" 
                                    class="w-full p-2 border border-green-400 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Overbought</label>
                                <input type="number" id="settingsRSIOverbought" value="70" min="60" max="80" 
                                    class="w-full p-2 border border-red-400 rounded text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-3">
                    <button onclick="resetAdvancedSettings()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-3 px-6 rounded-lg">
                        Reset to Defaults
                    </button>
                    <button onclick="saveAdvancedSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PROXY_URL = 'https://oanda-proxy.onrender.com/api';
        
        // Default settings
        const DEFAULT_SETTINGS = {
            emaPeriod: 50,
            atrPeriod: 20,
            deviationThreshold: 1.5,
            deviationThresholdGold: 2.0,
            atrSlopeMax: 0,
            slMultiplier: 2.5,
            rrFilter: true,
            sessionFilter: true,
            rsiFilter: false,
            rsiPeriod: 14,
            rsiOversold: 30,
            rsiOverbought: 70
        };

        let SETTINGS = {...DEFAULT_SETTINGS};
        let equityChart = null;

        // Settings functions
        function openAdvancedSettings() {
            document.getElementById('settingsEMAPeriod').value = SETTINGS.emaPeriod;
            document.getElementById('settingsATRPeriod').value = SETTINGS.atrPeriod;
            document.getElementById('settingsDeviation').value = SETTINGS.deviationThreshold;
            document.getElementById('settingsDeviationGold').value = SETTINGS.deviationThresholdGold;
            document.getElementById('settingsATRSlope').value = SETTINGS.atrSlopeMax;
            document.getElementById('settingsSLMultiplier').value = SETTINGS.slMultiplier;
            document.getElementById('settingsRRFilter').checked = SETTINGS.rrFilter;
            document.getElementById('settingsSessionFilter').checked = SETTINGS.sessionFilter;
            document.getElementById('settingsRSIFilter').checked = SETTINGS.rsiFilter;
            document.getElementById('settingsRSIPeriod').value = SETTINGS.rsiPeriod;
            document.getElementById('settingsRSIOversold').value = SETTINGS.rsiOversold;
            document.getElementById('settingsRSIOverbought').value = SETTINGS.rsiOverbought;
            document.getElementById('advancedModal').style.display = 'flex';
        }

        function closeAdvancedSettings() {
            document.getElementById('advancedModal').style.display = 'none';
        }

        function saveAdvancedSettings() {
            SETTINGS.emaPeriod = parseInt(document.getElementById('settingsEMAPeriod').value);
            SETTINGS.atrPeriod = parseInt(document.getElementById('settingsATRPeriod').value);
            SETTINGS.deviationThreshold = parseFloat(document.getElementById('settingsDeviation').value);
            SETTINGS.deviationThresholdGold = parseFloat(document.getElementById('settingsDeviationGold').value);
            SETTINGS.atrSlopeMax = parseFloat(document.getElementById('settingsATRSlope').value);
            SETTINGS.slMultiplier = parseFloat(document.getElementById('settingsSLMultiplier').value);
            SETTINGS.rrFilter = document.getElementById('settingsRRFilter').checked;
            SETTINGS.sessionFilter = document.getElementById('settingsSessionFilter').checked;
            SETTINGS.rsiFilter = document.getElementById('settingsRSIFilter').checked;
            SETTINGS.rsiPeriod = parseInt(document.getElementById('settingsRSIPeriod').value);
            SETTINGS.rsiOversold = parseInt(document.getElementById('settingsRSIOversold').value);
            SETTINGS.rsiOverbought = parseInt(document.getElementById('settingsRSIOverbought').value);
            closeAdvancedSettings();
            alert('‚úÖ Settings saved! Run backtest again to see results with new parameters.');
        }

        function resetAdvancedSettings() {
            SETTINGS = {...DEFAULT_SETTINGS};
            document.getElementById('settingsEMAPeriod').value = DEFAULT_SETTINGS.emaPeriod;
            document.getElementById('settingsATRPeriod').value = DEFAULT_SETTINGS.atrPeriod;
            document.getElementById('settingsDeviation').value = DEFAULT_SETTINGS.deviationThreshold;
            document.getElementById('settingsDeviationGold').value = DEFAULT_SETTINGS.deviationThresholdGold;
            document.getElementById('settingsATRSlope').value = DEFAULT_SETTINGS.atrSlopeMax;
            document.getElementById('settingsSLMultiplier').value = DEFAULT_SETTINGS.slMultiplier;
            document.getElementById('settingsRRFilter').checked = DEFAULT_SETTINGS.rrFilter;
            document.getElementById('settingsSessionFilter').checked = DEFAULT_SETTINGS.sessionFilter;
            document.getElementById('settingsRSIFilter').checked = DEFAULT_SETTINGS.rsiFilter;
            document.getElementById('settingsRSIPeriod').value = DEFAULT_SETTINGS.rsiPeriod;
            document.getElementById('settingsRSIOversold').value = DEFAULT_SETTINGS.rsiOversold;
            document.getElementById('settingsRSIOverbought').value = DEFAULT_SETTINGS.rsiOverbought;
        }

        // Fetch historical data - ULTRA FAST PARALLEL VERSION
        async function fetchHistoricalData(pair, granularity, yearsBack) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            
            progressContainer.style.display = 'block';
            progressText.textContent = 'Preparing to fetch data...';
            
            const now = new Date();
            const startDate = new Date(now.getTime() - yearsBack * 365 * 24 * 60 * 60 * 1000);
            
            // Fetch in parallel batches - 4 requests at once for maximum speed
            const PARALLEL_REQUESTS = 4;
            const allCandles = [];
            let currentDate = new Date(startDate);
            let totalRequests = 0;
            
            while (currentDate < now) {
                // Create batch of parallel requests
                const batchPromises = [];
                
                for (let i = 0; i < PARALLEL_REQUESTS; i++) {
                    if (currentDate >= now) break;
                    
                    const toDate = currentDate.toISOString();
                    
                    batchPromises.push(
                        fetch(`${PROXY_URL}/v3/instruments/${pair}/candles?count=5000&granularity=${granularity}&to=${toDate}&price=M`)
                            .then(r => r.json())
                            .then(data => data.candles.map(c => ({
                                time: c.time,
                                close: parseFloat(c.mid.c),
                                open: parseFloat(c.mid.o),
                                high: parseFloat(c.mid.h),
                                low: parseFloat(c.mid.l)
                            })))
                            .catch(err => {
                                console.error('Fetch error:', err);
                                return [];
                            })
                    );
                    
                    // Move date forward by ~5000 candles worth of time
                    const millisPerCandle = granularity === 'M30' ? 30*60*1000 : 
                                           granularity === 'H1' ? 60*60*1000 : 
                                           4*60*60*1000;
                    currentDate = new Date(currentDate.getTime() + 5000 * millisPerCandle);
                }
                
                // Wait for all requests in batch to complete
                const batchResults = await Promise.all(batchPromises);
                
                // Add results
                for (const candles of batchResults) {
                    if (candles.length > 0) {
                        allCandles.push(...candles);
                    }
                }
                
                totalRequests += batchResults.length;
                
                // Update progress
                const progress = Math.min(((currentDate - startDate) / (now - startDate)) * 100, 99);
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                progressText.textContent = `‚ö° Fetched ${allCandles.length.toLocaleString()} candles (${totalRequests} requests, ${PARALLEL_REQUESTS} parallel)`;
                
                // Check if last batch was small (means we're done)
                const lastBatchTotal = batchResults.reduce((sum, c) => sum + c.length, 0);
                if (lastBatchTotal < 5000) break;
            }
            
            // Sort by time and remove duplicates
            allCandles.sort((a, b) => new Date(a.time) - new Date(b.time));
            const uniqueCandles = [];
            let lastTime = null;
            for (const candle of allCandles) {
                if (candle.time !== lastTime) {
                    uniqueCandles.push(candle);
                    lastTime = candle.time;
                }
            }
            
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressText.textContent = `‚úÖ Fetched ${uniqueCandles.length.toLocaleString()} candles in ${totalRequests} requests`;
            
            return uniqueCandles;
        }

        // Calculate EMA
        function calculateEMA(prices, period) {
            if (prices.length < period) return null;
            
            const alpha = 2 / (period + 1);
            const sma = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            let ema = sma;
            for (let i = period; i < prices.length; i++) {
                ema = alpha * prices[i] + (1 - alpha) * ema;
            }
            
            return ema;
        }

        // Calculate ATR
        function calculateATR(candles, period) {
            if (candles.length < period + 1) return null;
            
            const trueRanges = [];
            for (let i = 1; i < candles.length; i++) {
                const high = candles[i].high;
                const low = candles[i].low;
                const prevClose = candles[i - 1].close;
                
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trueRanges.push(tr);
            }
            
            let atr = trueRanges.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < trueRanges.length; i++) {
                atr = (atr * (period - 1) + trueRanges[i]) / period;
            }
            
            return atr;
        }

        // Get ATR values for slope
        function getATRValues(candles, period, count = 6) {
            if (candles.length < period + count) return null;
            
            const atrValues = [];
            const trueRanges = [];
            
            for (let i = 1; i < candles.length; i++) {
                const high = candles[i].high;
                const low = candles[i].low;
                const prevClose = candles[i - 1].close;
                
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trueRanges.push(tr);
            }
            
            let atr = trueRanges.slice(0, period).reduce((a, b) => a + b, 0) / period;
            atrValues.push(atr);
            
            for (let i = period; i < trueRanges.length; i++) {
                atr = (atr * (period - 1) + trueRanges[i]) / period;
                if (i >= trueRanges.length - count + 1) {
                    atrValues.push(atr);
                }
            }
            
            return atrValues.slice(-count);
        }

        // Calculate RSI
        function calculateRSI(prices, period) {
            if (prices.length < period + 1) return null;
            
            const changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }
            
            const gains = changes.map(change => change > 0 ? change : 0);
            const losses = changes.map(change => change < 0 ? -change : 0);
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < changes.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
            }
            
            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            const rsi = 100 - (100 / (1 + rs));
            
            return rsi;
        }

        // Check if time is in trading window
        function isInTradingWindow(timestamp) {
            if (!SETTINGS.sessionFilter) return true;
            
            const date = new Date(timestamp);
            const day = date.getUTCDay();
            
            if (day === 0 || day === 6) return false;
            
            const hours = date.getUTCHours();
            const minutes = date.getUTCMinutes();
            const timeInMinutes = hours * 60 + minutes;
            
            // Skip open lockouts
            if ((timeInMinutes >= 480 && timeInMinutes < 510) ||
                (timeInMinutes >= 780 && timeInMinutes < 810)) {
                return false;
            }
            
            // Trading windows
            if ((timeInMinutes >= 30 && timeInMinutes < 450) ||
                (timeInMinutes >= 540 && timeInMinutes < 750) ||
                (timeInMinutes >= 900 && timeInMinutes < 1050)) {
                return true;
            }
            
            return false;
        }

        // Run backtest
        async function runBacktest() {
            const pair = document.getElementById('pairSelect').value;
            const granularity = document.getElementById('timeframeSelect').value;
            const yearsBack = parseInt(document.getElementById('yearsSelect').value);
            
            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="spinner"></span> Running...';
            
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
            
            try {
                // Fetch historical data
                const candles = await fetchHistoricalData(pair, granularity, yearsBack);
                
                if (candles.length < SETTINGS.emaPeriod + SETTINGS.atrPeriod + 10) {
                    alert('Insufficient data fetched. Please try again.');
                    return;
                }
                
                // Run backtest simulation
                document.getElementById('progressText').textContent = 'Running backtest simulation...';
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const results = await simulateBacktest(pair, candles);
                
                // Display results
                displayResults(results);
                
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
                
            } catch (error) {
                alert('Error running backtest: ' + error.message);
                console.error(error);
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = 'üöÄ Run Backtest';
            }
        }

        // Simulate backtest
        async function simulateBacktest(pair, candles) {
            const trades = [];
            let equity = 10000; // Starting capital
            const equityCurve = [{ date: candles[0].time, equity: 10000 }];
            
            let currentTrade = null;
            
            const isGold = pair === 'XAU_USD';
            const devThreshold = isGold ? SETTINGS.deviationThresholdGold : SETTINGS.deviationThreshold;
            
            for (let i = SETTINGS.emaPeriod + SETTINGS.atrPeriod + 10; i < candles.length; i++) {
                const windowCandles = candles.slice(Math.max(0, i - 500), i + 1);
                const prices = windowCandles.map(c => c.close);
                const currentCandle = candles[i];
                const currentPrice = currentCandle.close;
                
                // Check for exit if in trade
                if (currentTrade) {
                    let exit = false;
                    let exitPrice = currentPrice;
                    let exitReason = '';
                    
                    if (currentTrade.direction === 'BUY') {
                        if (currentPrice >= currentTrade.tp) {
                            exit = true;
                            exitPrice = currentTrade.tp;
                            exitReason = 'TP Hit';
                        } else if (currentPrice <= currentTrade.sl) {
                            exit = true;
                            exitPrice = currentTrade.sl;
                            exitReason = 'SL Hit';
                        }
                    } else if (currentTrade.direction === 'SELL') {
                        if (currentPrice <= currentTrade.tp) {
                            exit = true;
                            exitPrice = currentTrade.tp;
                            exitReason = 'TP Hit';
                        } else if (currentPrice >= currentTrade.sl) {
                            exit = true;
                            exitPrice = currentTrade.sl;
                            exitReason = 'SL Hit';
                        }
                    }
                    
                    if (exit) {
                        const pnl = currentTrade.direction === 'BUY' ? 
                            (exitPrice - currentTrade.entry) : 
                            (currentTrade.entry - exitPrice);
                        
                        const pnlPercent = (pnl / currentTrade.entry) * 100;
                        equity += equity * (pnlPercent / 100);
                        
                        currentTrade.exitPrice = exitPrice;
                        currentTrade.exitDate = currentCandle.time;
                        currentTrade.pnl = pnlPercent;
                        currentTrade.exitReason = exitReason;
                        
                        trades.push(currentTrade);
                        equityCurve.push({ date: currentCandle.time, equity: equity });
                        
                        currentTrade = null;
                    }
                    
                    continue; // Skip signal check if in trade
                }
                
                // Calculate indicators
                const ema = calculateEMA(prices, SETTINGS.emaPeriod);
                const atr = calculateATR(windowCandles, SETTINGS.atrPeriod);
                const atrValues = getATRValues(windowCandles, SETTINGS.atrPeriod, 6);
                
                if (!ema || !atr || !atrValues) continue;
                
                const atrSlope = atrValues[atrValues.length - 1] - atrValues[0];
                const deviation = Math.abs(currentPrice - ema) / atr;
                
                const rsi = SETTINGS.rsiFilter ? calculateRSI(prices, SETTINGS.rsiPeriod) : null;
                
                // Check filters
                if (deviation < devThreshold) continue;
                if (atrSlope > SETTINGS.atrSlopeMax) continue;
                if (!isInTradingWindow(currentCandle.time)) continue;
                
                // Determine signal
                let direction = null;
                if (currentPrice < ema) {
                    direction = 'BUY';
                    if (SETTINGS.rsiFilter && rsi && rsi >= SETTINGS.rsiOversold) continue;
                } else if (currentPrice > ema) {
                    direction = 'SELL';
                    if (SETTINGS.rsiFilter && rsi && rsi <= SETTINGS.rsiOverbought) continue;
                }
                
                if (!direction) continue;
                
                // Calculate entry, TP, SL
                const entry = currentPrice;
                const tp = ema;
                const sl = direction === 'BUY' ? 
                    entry - SETTINGS.slMultiplier * atr : 
                    entry + SETTINGS.slMultiplier * atr;
                
                const risk = Math.abs(entry - sl);
                const reward = Math.abs(tp - entry);
                const rr = reward / risk;
                
                // R:R filter
                if (SETTINGS.rrFilter && rr < 1.0) continue;
                
                // Enter trade
                currentTrade = {
                    tradeNum: trades.length + 1,
                    entryDate: currentCandle.time,
                    direction: direction,
                    entry: entry,
                    tp: tp,
                    sl: sl,
                    rr: rr
                };
            }
            
            // Calculate statistics
            const winningTrades = trades.filter(t => t.pnl > 0);
            const losingTrades = trades.filter(t => t.pnl < 0);
            
            const totalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
            const winRate = trades.length > 0 ? (winningTrades.length / trades.length) * 100 : 0;
            
            const avgWin = winningTrades.length > 0 ? 
                winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? 
                losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length : 0;
            
            const grossProfit = winningTrades.reduce((sum, t) => sum + t.pnl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : 0;
            
            // Calculate max drawdown
            let maxEquity = 10000;
            let maxDrawdown = 0;
            for (const point of equityCurve) {
                if (point.equity > maxEquity) maxEquity = point.equity;
                const drawdown = ((maxEquity - point.equity) / maxEquity) * 100;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            }
            
            const roi = ((equity - 10000) / 10000) * 100;
            
            return {
                trades,
                equityCurve,
                stats: {
                    roi,
                    winRate,
                    totalTrades: trades.length,
                    winningTrades: winningTrades.length,
                    losingTrades: losingTrades.length,
                    avgWin,
                    avgLoss,
                    profitFactor,
                    maxDrawdown
                }
            };
        }

        // Evaluate backtest performance
        function evaluatePerformance(stats, yearsBack) {
            // Normalize ROI to 2-year equivalent for consistent benchmarking
            const normalizedROI = (stats.roi / yearsBack) * 2;
            
            // Evaluate each metric
            const ratings = {
                roi: evaluateROI(normalizedROI),
                winRate: evaluateWinRate(stats.winRate),
                profitFactor: evaluateProfitFactor(stats.profitFactor),
                drawdown: evaluateDrawdown(stats.maxDrawdown),
                trades: evaluateTrades(stats.totalTrades, yearsBack),
                rr: evaluateRR(stats.avgWin, stats.avgLoss)
            };
            
            // Calculate overall score (0-100)
            const weights = { roi: 25, winRate: 15, profitFactor: 20, drawdown: 20, trades: 10, rr: 10 };
            let totalScore = 0;
            for (const [key, weight] of Object.entries(weights)) {
                totalScore += ratings[key].score * weight / 100;
            }
            
            // Determine overall rating
            let overall;
            if (totalScore >= 80) {
                overall = { level: 'Excellent', color: 'from-green-500 to-emerald-600', icon: 'üåü', textColor: 'text-white' };
            } else if (totalScore >= 65) {
                overall = { level: 'Good', color: 'from-blue-500 to-blue-600', icon: '‚úÖ', textColor: 'text-white' };
            } else if (totalScore >= 50) {
                overall = { level: 'Acceptable', color: 'from-yellow-400 to-yellow-500', icon: '‚ö†Ô∏è', textColor: 'text-slate-900' };
            } else if (totalScore >= 35) {
                overall = { level: 'Poor', color: 'from-orange-400 to-orange-500', icon: '‚ùå', textColor: 'text-white' };
            } else {
                overall = { level: 'Failed', color: 'from-red-500 to-red-600', icon: 'üö´', textColor: 'text-white' };
            }
            
            // Generate recommendation
            const recommendation = generateRecommendation(overall.level, ratings, stats, yearsBack);
            
            return { ratings, overall, recommendation, score: totalScore };
        }
        
        function evaluateROI(normalizedROI) {
            if (normalizedROI >= 30) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (normalizedROI >= 20) return { score: 85, rating: 'Very Good', icon: '‚úÖ', color: 'text-green-600' };
            if (normalizedROI >= 15) return { score: 75, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (normalizedROI >= 10) return { score: 60, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (normalizedROI >= 5) return { score: 40, rating: 'Poor', icon: '‚ùå', color: 'text-orange-600' };
            return { score: 0, rating: 'Failed', icon: 'üö´', color: 'text-red-600' };
        }
        
        function evaluateWinRate(winRate) {
            if (winRate >= 60) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (winRate >= 55) return { score: 85, rating: 'Very Good', icon: '‚úÖ', color: 'text-green-600' };
            if (winRate >= 50) return { score: 75, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (winRate >= 45) return { score: 60, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (winRate >= 40) return { score: 40, rating: 'Poor', icon: '‚ùå', color: 'text-orange-600' };
            return { score: 20, rating: 'Failed', icon: 'üö´', color: 'text-red-600' };
        }
        
        function evaluateProfitFactor(pf) {
            if (pf >= 2.0) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (pf >= 1.7) return { score: 85, rating: 'Very Good', icon: '‚úÖ', color: 'text-green-600' };
            if (pf >= 1.5) return { score: 75, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (pf >= 1.3) return { score: 60, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (pf >= 1.1) return { score: 40, rating: 'Poor', icon: '‚ùå', color: 'text-orange-600' };
            return { score: 0, rating: 'Failed', icon: 'üö´', color: 'text-red-600' };
        }
        
        function evaluateDrawdown(dd) {
            if (dd <= 15) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (dd <= 20) return { score: 85, rating: 'Very Good', icon: '‚úÖ', color: 'text-green-600' };
            if (dd <= 25) return { score: 75, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (dd <= 30) return { score: 60, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (dd <= 40) return { score: 40, rating: 'Poor', icon: '‚ùå', color: 'text-orange-600' };
            return { score: 20, rating: 'Failed', icon: 'üö´', color: 'text-red-600' };
        }
        
        function evaluateTrades(trades, years) {
            const tradesPerYear = trades / years;
            if (tradesPerYear >= 40 && tradesPerYear <= 150) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (tradesPerYear >= 25 && tradesPerYear <= 200) return { score: 85, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (tradesPerYear >= 15 && tradesPerYear <= 250) return { score: 70, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (tradesPerYear >= 10) return { score: 50, rating: 'Limited', icon: '‚ö†Ô∏è', color: 'text-orange-600' };
            return { score: 30, rating: 'Too Few', icon: '‚ùå', color: 'text-red-600' };
        }
        
        function evaluateRR(avgWin, avgLoss) {
            const rr = Math.abs(avgWin / avgLoss);
            if (rr >= 1.3) return { score: 100, rating: 'Excellent', icon: 'üåü', color: 'text-green-600' };
            if (rr >= 1.1) return { score: 85, rating: 'Good', icon: '‚úÖ', color: 'text-blue-600' };
            if (rr >= 1.0) return { score: 70, rating: 'Acceptable', icon: '‚ö†Ô∏è', color: 'text-yellow-600' };
            if (rr >= 0.8) return { score: 50, rating: 'Poor', icon: '‚ùå', color: 'text-orange-600' };
            return { score: 30, rating: 'Failed', icon: 'üö´', color: 'text-red-600' };
        }
        
        function generateRecommendation(level, ratings, stats, yearsBack) {
            let rec = '';
            
            if (level === 'Excellent') {
                rec = `üéâ <strong>Outstanding performance!</strong> This strategy shows exceptional results across all metrics. ` +
                      `It's ready for paper trading. Monitor performance for 1-2 months, then consider going live with proper position sizing. ` +
                      `Expected annual return: ${(stats.roi / yearsBack).toFixed(1)}% with controlled risk.`;
            } else if (level === 'Good') {
                rec = `‚úÖ <strong>Solid strategy!</strong> The results are consistently good across most metrics. ` +
                      `This strategy is worth paper trading. Test it for 1-2 months to verify performance matches backtesting. `;
                
                // Add specific suggestions
                if (ratings.drawdown.score < 70) rec += `Consider tighter risk management to reduce drawdown. `;
                if (ratings.winRate.score < 70) rec += `Win rate could be improved - try enabling RSI filter. `;
                
                rec += `Expected annual return: ${(stats.roi / yearsBack).toFixed(1)}%.`;
            } else if (level === 'Acceptable') {
                rec = `‚ö†Ô∏è <strong>Marginal performance.</strong> While profitable, results could be better. Consider optimization: `;
                
                const suggestions = [];
                if (ratings.roi.score < 60) suggestions.push('increase deviation threshold for better quality signals');
                if (ratings.winRate.score < 60) suggestions.push('enable RSI filter for confirmation');
                if (ratings.drawdown.score < 60) suggestions.push('tighten stop loss to reduce drawdown');
                if (ratings.trades.score < 60) suggestions.push('adjust filters to get more trades');
                
                rec += suggestions.slice(0, 2).join(', ') + '. ';
                rec += `Or try a different pair/timeframe. Paper trade with caution if proceeding.`;
            } else if (level === 'Poor') {
                rec = `‚ùå <strong>Weak performance.</strong> This strategy is barely profitable or inconsistent. <strong>Do not trade live.</strong> `;
                rec += `Try these improvements: `;
                
                const fixes = [];
                if (ratings.roi.score < 40) fixes.push('test on different pairs - this pair may not be suitable');
                if (ratings.profitFactor.score < 40) fixes.push('increase deviation threshold to 2.0+');
                if (ratings.winRate.score < 40) fixes.push('enable all filters (RSI, session, R:R)');
                if (ratings.drawdown.score < 40) fixes.push('reduce SL multiplier to 2.0');
                
                rec += fixes.slice(0, 3).join('; ') + '.';
            } else {
                rec = `üö´ <strong>Failed strategy - do NOT trade!</strong> `;
                if (stats.roi < 0) rec += `The strategy loses money over time. `;
                if (stats.profitFactor < 1.0) rec += `Losses exceed profits. `;
                if (stats.maxDrawdown > 50) rec += `Drawdown is too severe. `;
                rec += `This pair/timeframe combination is not suitable for VNMR Classic. Try a completely different pair or timeframe.`;
            }
            
            return rec;
        }

        // Display results
        function displayResults(results) {
            const { trades, equityCurve, stats } = results;
            const yearsBack = parseInt(document.getElementById('yearsSelect').value);
            
            // Evaluate performance
            const assessment = evaluatePerformance(stats, yearsBack);
            
            // Update assessment card
            const assessmentCard = document.getElementById('assessmentCard');
            assessmentCard.className = `rounded-lg shadow-lg p-6 mb-6 bg-gradient-to-r ${assessment.overall.color}`;
            assessmentCard.style.display = 'block';
            
            document.getElementById('assessmentIcon').textContent = assessment.overall.icon;
            document.getElementById('assessmentTitle').textContent = `${assessment.overall.level} Strategy`;
            document.getElementById('assessmentTitle').className = `text-3xl font-bold mb-2 ${assessment.overall.textColor}`;
            document.getElementById('assessmentSubtitle').textContent = `Overall Score: ${Math.round(assessment.score)}/100`;
            document.getElementById('assessmentSubtitle').className = `text-lg mb-4 ${assessment.overall.textColor}`;
            
            // Update individual metric ratings
            document.getElementById('ratingROI').textContent = assessment.ratings.roi.icon;
            document.getElementById('ratingROIText').textContent = assessment.ratings.roi.rating;
            document.getElementById('ratingROIText').className = assessment.ratings.roi.color;
            
            document.getElementById('ratingWinRate').textContent = assessment.ratings.winRate.icon;
            document.getElementById('ratingWinRateText').textContent = assessment.ratings.winRate.rating;
            document.getElementById('ratingWinRateText').className = assessment.ratings.winRate.color;
            
            document.getElementById('ratingPF').textContent = assessment.ratings.profitFactor.icon;
            document.getElementById('ratingPFText').textContent = assessment.ratings.profitFactor.rating;
            document.getElementById('ratingPFText').className = assessment.ratings.profitFactor.color;
            
            document.getElementById('ratingDD').textContent = assessment.ratings.drawdown.icon;
            document.getElementById('ratingDDText').textContent = assessment.ratings.drawdown.rating;
            document.getElementById('ratingDDText').className = assessment.ratings.drawdown.color;
            
            document.getElementById('ratingTrades').textContent = assessment.ratings.trades.icon;
            document.getElementById('ratingTradesText').textContent = assessment.ratings.trades.rating;
            document.getElementById('ratingTradesText').className = assessment.ratings.trades.color;
            
            document.getElementById('ratingRR').textContent = assessment.ratings.rr.icon;
            document.getElementById('ratingRRText').textContent = assessment.ratings.rr.rating;
            document.getElementById('ratingRRText').className = assessment.ratings.rr.color;
            
            document.getElementById('assessmentRecommendationText').innerHTML = assessment.recommendation;
            
            // Update metrics
            document.getElementById('metricROI').textContent = `${stats.roi >= 0 ? '+' : ''}${stats.roi.toFixed(2)}%`;
            document.getElementById('metricWinRate').textContent = `${stats.winRate.toFixed(1)}%`;
            document.getElementById('metricProfitFactor').textContent = stats.profitFactor.toFixed(2);
            document.getElementById('metricDrawdown').textContent = `-${stats.maxDrawdown.toFixed(2)}%`;
            document.getElementById('metricTotalTrades').textContent = stats.totalTrades;
            document.getElementById('metricWinningTrades').textContent = stats.winningTrades;
            document.getElementById('metricLosingTrades').textContent = stats.losingTrades;
            document.getElementById('metricAvgWin').textContent = `+${stats.avgWin.toFixed(2)}%`;
            document.getElementById('metricAvgLoss').textContent = `${stats.avgLoss.toFixed(2)}%`;
            
            // Draw equity curve
            drawEquityCurve(equityCurve);
            
            // Populate trade log
            populateTradeLog(trades);
        }

        // Draw equity curve
        function drawEquityCurve(equityCurve) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (equityChart) {
                equityChart.destroy();
            }
            
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: equityCurve.map(point => new Date(point.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Equity',
                        data: equityCurve.map(point => point.equity),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Equity: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }

        // Populate trade log
        function populateTradeLog(trades) {
            const tbody = document.getElementById('tradeLogBody');
            tbody.innerHTML = '';
            
            // Show last 50 trades
            const displayTrades = trades.slice(-50).reverse();
            
            for (const trade of displayTrades) {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-200 hover:bg-slate-50';
                
                const pnlClass = trade.pnl > 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="p-3 text-sm">#${trade.tradeNum}</td>
                    <td class="p-3 text-sm">${new Date(trade.entryDate).toLocaleString()}</td>
                    <td class="p-3 text-sm"><span class="px-2 py-1 rounded ${trade.direction === 'BUY' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${trade.direction}</span></td>
                    <td class="p-3 text-sm">${trade.entry.toFixed(5)}</td>
                    <td class="p-3 text-sm">${trade.exitPrice.toFixed(5)}</td>
                    <td class="p-3 text-sm">${new Date(trade.exitDate).toLocaleString()}</td>
                    <td class="p-3 text-sm font-semibold ${pnlClass}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}%</td>
                    <td class="p-3 text-sm">${trade.rr.toFixed(2)}</td>
                `;
                
                tbody.appendChild(row);
            }
        }
    </script>
</body>
</html>
