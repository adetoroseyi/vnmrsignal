<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mean Reversion Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        .signal-card {
            transition: all 0.3s ease;
        }
        .signal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">
                    üìä Mean Reversion Trading Dashboard
                </h1>
                <p class="text-gray-600">
                    Live signals ‚Ä¢ Statistical validation ‚Ä¢ Professional risk management
                </p>
                <p id="lastUpdate" class="text-sm text-gray-500 mt-1"></p>
            </div>

            <!-- Important Notice -->
            <div id="proxyNotice" class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-8">
                <h3 class="text-lg font-bold text-yellow-900 mb-2">‚ö†Ô∏è Proxy Server Required</h3>
                <p class="text-yellow-800 mb-3">
                    This dashboard requires the proxy server to be running to fetch data from Oanda.
                </p>
                <div class="bg-white p-4 rounded border border-yellow-300">
                    <p class="font-semibold text-gray-900 mb-2">Start the proxy server:</p>
                    <code class="bg-gray-800 text-green-400 px-3 py-2 rounded block">node oanda_proxy.js</code>
                    <p class="text-sm text-gray-600 mt-2">The proxy should be running on <strong>http://localhost:3001</strong></p>
                </div>
            </div>

            <!-- Performance Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-500 mb-1">Pairs Analyzed</div>
                    <div id="totalPairs" class="text-3xl font-bold text-gray-900">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-500 mb-1">Qualified Pairs</div>
                    <div id="qualifiedPairs" class="text-3xl font-bold text-green-600">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-500 mb-1">Active Signals</div>
                    <div id="activeSignals" class="text-3xl font-bold text-purple-600">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Status</div>
                            <div id="status" class="text-sm font-semibold text-gray-900">Loading...</div>
                        </div>
                        <button onclick="refreshData()" id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Signals Container -->
            <div id="signalsContainer" class="space-y-6">
                <div class="bg-white rounded-lg shadow p-12 text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading market data...</p>
                </div>
            </div>

            <!-- Strategy Info -->
            <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border border-blue-200">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìã Strategy Rules</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Entry Criteria</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <span class="text-green-600 mr-2">‚úì</span>
                                <span>Half-life &lt; 50 days (mean-reverting only)</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-600 mr-2">‚úì</span>
                                <span>3-day cumulative move &gt; 1%</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-600 mr-2">‚úì</span>
                                <span>|Z-Score| &gt; 2.0 for strong signals</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-600 mr-2">‚úì</span>
                                <span>Contrarian direction (fade the move)</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Exit Levels</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <span class="text-purple-600 mr-2">‚Ä¢</span>
                                <span>Take Profit: Mean distance √∑ 2</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-purple-600 mr-2">‚Ä¢</span>
                                <span>Stop Loss: 1.5√ó ATR from entry</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-purple-600 mr-2">‚Ä¢</span>
                                <span>Time Stop: 2√ó half-life (max 10 days)</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-purple-600 mr-2">‚Ä¢</span>
                                <span>Expected Win Rate: 70-75%</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PROXY_URL = 'https://oanda-proxy.onrender.com/api';
        const PAIRS = ['EUR_USD', 'GBP_USD', 'USD_JPY', 'USD_CAD', 'AUD_USD', 'XAU_USD', 'EUR_GBP', 'AUD_NZD', 'EUR_CHF', 'NZD_USD', 'USD_CHF', 'EUR_AUD', 'GBP_AUD', 'AUD_CAD'];
        const ACCOUNT_ID = '101-004-37956081-001';

        // State
        let marketData = {};
        let qualifiedPairsData = [];

        // Fetch candles from Oanda via proxy
        async function fetchCandles(pair, count = 500) {
            try {
                const response = await fetch(
                    `${PROXY_URL}/v3/instruments/${pair}/candles?count=${count}&granularity=D&price=M`
                );
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.candles.map(c => ({
                    time: c.time,
                    close: parseFloat(c.mid.c),
                    open: parseFloat(c.mid.o),
                    high: parseFloat(c.mid.h),
                    low: parseFloat(c.mid.l)
                }));
            } catch (error) {
                console.error(`Error fetching ${pair}:`, error);
                return null;
            }
        }

        // Calculate half-life for mean reversion
        function calculateHalfLife(prices) {
            if (prices.length < 30) return Infinity;
            
            try {
                const logPrices = prices.map(p => Math.log(p));
                const n = logPrices.length;
                const yLag = logPrices.slice(0, n - 1);
                const yDiff = logPrices.slice(1).map((val, i) => val - logPrices[i]);
                
                const nPoints = yLag.length;
                const sumX = yLag.reduce((a, b) => a + b, 0);
                const sumY = yDiff.reduce((a, b) => a + b, 0);
                const sumXX = yLag.reduce((a, b) => a + b * b, 0);
                const sumXY = yLag.reduce((a, b, i) => a + b * yDiff[i], 0);
                
                const slope = (nPoints * sumXY - sumX * sumY) / (nPoints * sumXX - sumX * sumX);
                
                if (slope >= -0.001) return Infinity;
                
                const theta = -slope;
                const halfLife = Math.log(2) / theta;
                
                return (halfLife > 0 && halfLife < 500) ? halfLife : Infinity;
            } catch (error) {
                return Infinity;
            }
        }

        // Calculate Z-score
        function calculateZScore(prices, lookback = 20) {
            if (prices.length < lookback) return 0;
            
            const recent = prices.slice(-lookback);
            const mean = recent.reduce((a, b) => a + b, 0) / recent.length;
            const variance = recent.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recent.length;
            const std = Math.sqrt(variance);
            
            const currentPrice = prices[prices.length - 1];
            return std > 0 ? (currentPrice - mean) / std : 0;
        }

        // Calculate ATR
        function calculateATR(candles, period = 14) {
            if (candles.length < period + 1) return 0;
            
            const recentCandles = candles.slice(-period - 1);
            const trueRanges = [];
            
            for (let i = 1; i < recentCandles.length; i++) {
                const high = recentCandles[i].high;
                const low = recentCandles[i].low;
                const prevClose = recentCandles[i - 1].close;
                
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trueRanges.push(tr);
            }
            
            return trueRanges.reduce((a, b) => a + b, 0) / trueRanges.length;
        }

        // Analyze pair
        function analyzePair(pair, candles) {
            if (!candles || candles.length < 50) return null;

            const prices = candles.map(c => c.close);
            const currentPrice = prices[prices.length - 1];
            
            const halfLife = calculateHalfLife(prices);
            
            if (halfLife >= 50) {
                return {
                    pair,
                    qualified: false,
                    halfLife,
                    currentPrice,
                    reason: 'Half-life too high (not mean-reverting enough)'
                };
            }
            
            const price3DaysAgo = prices[prices.length - 4];
            const threeDayReturn = ((currentPrice - price3DaysAgo) / price3DaysAgo) * 100;
            
            const lookback = Math.max(10, Math.min(Math.floor(halfLife), 50));
            const zScore = calculateZScore(prices, lookback);
            const atr = calculateATR(candles);
            
            const meanPrice = prices.slice(-lookback).reduce((a, b) => a + b, 0) / lookback;
            const deviation = Math.abs(currentPrice - meanPrice);
            
            const hasThreeDayMove = Math.abs(threeDayReturn) > 1.0;
            const hasZScoreSignal = Math.abs(zScore) > 2.0;
            const hasSignal = hasThreeDayMove && hasZScoreSignal;
            
            const direction = threeDayReturn > 0 ? 'SHORT' : 'LONG';
            
            let entry, takeProfit, stopLoss;
            
            if (direction === 'LONG') {
                entry = currentPrice;
                takeProfit = currentPrice + (deviation * 0.5);
                stopLoss = currentPrice - (1.5 * atr);
            } else {
                entry = currentPrice;
                takeProfit = currentPrice - (deviation * 0.5);
                stopLoss = currentPrice + (1.5 * atr);
            }
            
            const maxHoldDays = Math.min(Math.floor(halfLife * 2), 10);
            const isJPY = pair.includes('JPY');
            const pipMultiplier = isJPY ? 100 : 10000;
            
            return {
                pair,
                qualified: true,
                halfLife: halfLife.toFixed(1),
                currentPrice,
                threeDayReturn,
                zScore,
                atr,
                meanPrice,
                hasSignal,
                signalStrength: (hasThreeDayMove && Math.abs(zScore) > 2.5) ? 'STRONG' : 
                              hasSignal ? 'MODERATE' : 'NONE',
                direction,
                entry: entry.toFixed(5),
                takeProfit: takeProfit.toFixed(5),
                stopLoss: stopLoss.toFixed(5),
                maxHoldDays,
                tpPips: (Math.abs(takeProfit - entry) * pipMultiplier).toFixed(1),
                slPips: (Math.abs(stopLoss - entry) * pipMultiplier).toFixed(1),
                riskReward: (Math.abs(takeProfit - entry) / Math.abs(stopLoss - entry)).toFixed(2)
            };
        }

        // Render signals
        function renderSignals() {
            const container = document.getElementById('signalsContainer');
            
            if (qualifiedPairsData.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-12 text-center">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-xl text-gray-600 mb-2">No pairs currently qualify</p>
                        <p class="text-sm text-gray-500">All pairs have half-life ‚â• 50 days</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = qualifiedPairsData.map(pair => `
                <div class="signal-card bg-white rounded-lg shadow-lg p-6 border-2 ${
                    pair.hasSignal 
                        ? pair.signalStrength === 'STRONG'
                            ? 'border-red-500 bg-red-50'
                            : 'border-yellow-500 bg-yellow-50'
                        : 'border-gray-200'
                }">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">${pair.pair.replace('_', '/')}</h3>
                            <div class="flex items-center gap-4 mt-2 text-sm">
                                <span class="text-gray-600">
                                    Half-life: <strong>${pair.halfLife} days</strong>
                                </span>
                                <span class="${Math.abs(pair.threeDayReturn) > 1 ? 'text-red-600' : 'text-gray-600'}">
                                    3-Day: <strong>${pair.threeDayReturn.toFixed(2)}%</strong>
                                </span>
                                <span class="${Math.abs(pair.zScore) > 2 ? 'text-red-600' : 'text-gray-600'}">
                                    Z-Score: <strong>${pair.zScore.toFixed(2)}</strong>
                                </span>
                            </div>
                        </div>
                        ${pair.hasSignal ? `
                            <div class="px-4 py-2 rounded-lg font-bold ${
                                pair.signalStrength === 'STRONG'
                                    ? 'bg-red-600 text-white'
                                    : 'bg-yellow-500 text-gray-900'
                            }">
                                ${pair.signalStrength} ${pair.direction} SIGNAL
                            </div>
                        ` : ''}
                    </div>

                    <!-- Current Price -->
                    <div class="mb-4 pb-4 border-b">
                        <div class="text-sm text-gray-500 mb-1">Current Price</div>
                        <div class="text-4xl font-bold text-gray-900">${pair.currentPrice.toFixed(5)}</div>
                    </div>

                    ${pair.hasSignal ? `
                        <!-- Trade Levels -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg border-2 border-blue-500">
                                <div class="text-xs font-semibold text-blue-600 uppercase mb-1">Entry</div>
                                <div class="text-2xl font-bold text-gray-900">${pair.entry}</div>
                                <div class="text-xs text-gray-500 mt-1">${pair.direction}</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border-2 border-green-500">
                                <div class="text-xs font-semibold text-green-600 uppercase mb-1">Take Profit</div>
                                <div class="text-2xl font-bold text-gray-900">${pair.takeProfit}</div>
                                <div class="text-xs text-gray-500 mt-1">${pair.tpPips} pips</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border-2 border-red-500">
                                <div class="text-xs font-semibold text-red-600 uppercase mb-1">Stop Loss</div>
                                <div class="text-2xl font-bold text-gray-900">${pair.stopLoss}</div>
                                <div class="text-xs text-gray-500 mt-1">${pair.slPips} pips</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border-2 border-purple-500">
                                <div class="text-xs font-semibold text-purple-600 uppercase mb-1">Max Hold</div>
                                <div class="text-2xl font-bold text-gray-900">${pair.maxHoldDays}</div>
                                <div class="text-xs text-gray-500 mt-1">days</div>
                            </div>
                        </div>

                        <!-- Risk/Reward -->
                        <div class="mt-4 pt-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <strong>Risk/Reward:</strong> 1:${pair.riskReward}
                            </div>
                            <div class="text-sm text-gray-600">
                                <strong>Mean Price:</strong> ${pair.meanPrice.toFixed(5)}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-4 text-gray-500">
                            No entry signal yet - waiting for |Z-score| > 2.0 and 3-day move > 1%
                        </div>
                    `}
                </div>
            `).join('');
        }

        // Fetch and analyze all data
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>';
            status.textContent = 'Loading...';

            qualifiedPairsData = [];
            const allPairs = [];

            for (const pair of PAIRS) {
                const candles = await fetchCandles(pair);
                if (candles) {
                    const analysis = analyzePair(pair, candles);
                    if (analysis) {
                        allPairs.push(analysis);
                        if (analysis.qualified) {
                            qualifiedPairsData.push(analysis);
                        }
                    }
                }
                await new Promise(r => setTimeout(r, 200));
            }

            qualifiedPairsData.sort((a, b) => {
                if (a.hasSignal && !b.hasSignal) return -1;
                if (!a.hasSignal && b.hasSignal) return 1;
                return Math.abs(b.zScore) - Math.abs(a.zScore);
            });

            // Update stats
            document.getElementById('totalPairs').textContent = PAIRS.length;
            document.getElementById('qualifiedPairs').textContent = qualifiedPairsData.length;
            document.getElementById('activeSignals').textContent = 
                qualifiedPairsData.filter(p => p.hasSignal).length;
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;
            status.textContent = 'Live';

            renderSignals();

            btn.disabled = false;
            btn.textContent = 'Refresh';

            // Hide proxy notice if successful
            if (allPairs.length > 0) {
                document.getElementById('proxyNotice').style.display = 'none';
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);

        // Initial load
        refreshData();
    </script>
</body>
</html>
